<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-date-picker/paper-button-date-picker.html">
<link rel="import" href="../moment-js/moment-js.html">
<!--
`<laterooms-datepicker hotelid="73022" affiliateid="3095">` This is a Polymer Element that pulls in rates from Laterooms API. It is still a work in progress and what is here is pre production.
@demo demo2.html
-->

<dom-module id="laterooms-datepicker">
	<template>
		<iron-ajax auto url="{{_url}}" last-response="{{data}}"></iron-ajax>
		<div class="layout center">
			<div on-tap="show" class="box center horizontal layout">
				<h3>Check in</h3><paper-button-date-picker date="{{checkIn}}" locale="en-gb"></paper-button-date-picker>
				<h3>Check out</h3><paper-button-date-picker date="{{checkOut}}" locale="en-gb"></paper-button-date-picker>
  		</div>
  		<template is="dom-if" if="{{show}}">
  		  <div class="layout horizontal">
  			  <a style="text-decoration:none;color:#222" href="{{_link}}">
				    <paper-material class="layout middle" style="max-width: 300px;">
					    <div style="margin:40px 40px;text-align:center;padding: 20px">
					  	  Laterooms Rate From
					  	  <p>{{rate}}</p>
              </div>
				    </paper-material>
				  </a>
				  <a style="text-decoration:none;color:#222" href="{{_link}}">
				    <paper-material class="layout middle" style="max-width: 300px;">
					    <div style="margin:40px 40px;text-align:center;padding: 20px">
								<content></content>
					    </div>
					  </paper-material>
				  </a>
			  </div>
			</template>
		</div>
  </template>
</dom-module>
<script>
Polymer({
  is: 'laterooms-datepicker',
  properties: {
    day: {computed: 'getDay(checkIn)'},
    month: {computed: 'getMonth(checkIn)'},
    year: {computed: 'getYear(checkIn)'},
    nights: {computed: 'getNights(checkIn, checkOut)'},
    hotelid: {value: 69407},
    affiliateid: {value: 3095},
    _url: {computed: 'getUrl(day, month, year, nights, hotelid, affiliateid)'},
    _link: {computed: 'getLink(day, month, year, nights, hotelid, affiliateid)'},
    rate: {computed: 'getRate(data)'}
  },
  show: function () {this.show = true},
  getDay: function (checkIn) { return checkIn.getDate() },
  getMonth: function (checkIn) { return checkIn.getMonth() + 1 },
  getYear: function (checkIn) { return checkIn.getFullYear() },
  getNights: function (checkIn, checkOut) {
    var a = moment(checkOut - checkIn)
    if (a > 0) {
      return Math.ceil(a / (1000 * 60 * 60 * 24))
    } else {
      return undefined
    }
  },
  getUrl: function (day, month, year, nights, hotelid, affiliateid) {
    return '/bower_components/laterooms-ratepicker/server/index.php?u=%3Faid%3D' + affiliateid + '%26rtype%3D7%26hids%3D' + hotelid + '%26sdate%3D' + year + '-' + month + '-' + day + '%26nights%3D' + nights
  },
  getLink: function (day, month, year, nights, hotelid, affiliateid) {
    if (('' + day).length === 1) day = '0' + day
    if (('' + month).length === 1) month = '0' + month
    return 'http://www.laterooms.com/en/p' + affiliateid +
    '/hotel-reservations/' + hotelid + '.aspx?d=' + year + month + day +
    '&n=' + nights + '&rt=2-0&adult=2&child=0'
  // working link http://www.laterooms.com/en/p3095/hotel-reservations/73022.aspx?d=20151201&n=4&rt=2-0&adult=2&child=0
  },
  getRate: function (data) {
    var rates = []
    if (data.hasOwnProperty('lr_rates') &&
      data.lr_rates.hasOwnProperty('hotel') &&
      data.lr_rates.hotel.hasOwnProperty('hotel_rooms') &&
      data.lr_rates.hotel.hotel_rooms.hasOwnProperty('room') &&
      data.lr_rates.hotel.hotel_rooms.room.hasOwnProperty('room')) {
      for (var index = 0; index < data.lr_rates.hotel.hotel_rooms.room.length; ++index) {
        var room = 0
  
        for (var indexRate = 0; indexRate < data.lr_rates.hotel.hotel_rooms.room[index].rate.length; ++indexRate) {
          room = room + (data.lr_rates.hotel.hotel_rooms.room[index].rate[indexRate].price.replace('£', '') * 1)
        }

        rates.push(room)
      // TODO 1 night fix
      } 
    } else {
      // test of other data layout
    }
    if (rates.sort()[rates.length - 1] > 1) {
      this.show = true
      return '£' + rates.sort()[rates.length - 1].toFixed(2)
    } else {
      return 'No rates available'
    }
  }
})
</script>
